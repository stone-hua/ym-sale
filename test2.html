<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIåŒ»ç¾é”€å† åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #07C160; --bg: #f2f2f2; --white: #ffffff; --text: #111; --text-sub: #888; --border: #e0e0e0; --user-bg: #95ec69; --ai-bg: #ffffff; --sidebar-bg: #f7f7f7; }
        [data-theme="dark"] { --primary: #07C160; --bg: #111; --white: #1e1e1e; --text: #eee; --text-sub: #aaa; --border: #333; --user-bg: #056a36; --ai-bg: #2c2c2c; --sidebar-bg: #1a1a1a; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { width: 100%; height: 100dvh; overflow: hidden; background: var(--bg); font-family: -apple-system, sans-serif; display: flex; justify-content: center; }

        .app-container { width: 100%; height: 100%; max-width: 480px; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        .header { height: 50px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; color: var(--text); }
        .header-title { font-weight: 600; font-size: 16px; }
        .header-btn { font-size: 18px; cursor: pointer; padding: 8px; }

        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; transition: opacity 0.3s; }
        .chat-area.fading { opacity: 0; }
        
        .message { display: flex; align-items: flex-start; gap: 10px; max-width: 100%; }
        .message.user { flex-direction: row-reverse; }
        .avatar { width: 40px; height: 40px; border-radius: 6px; background-size: cover; flex-shrink: 0; }
        .message.user .avatar { display: none; }
        .bubble-content { max-width: 85%; }
        
        .bubble { padding: 12px 16px; border-radius: 10px; font-size: 15px; line-height: 1.6; color: var(--text); word-wrap: break-word; position: relative; }
        .message.ai .bubble { background: var(--ai-bg); border: 1px solid var(--border); }
        .message.user .bubble { background: var(--user-bg); border: 1px solid transparent; color: #000; }
        [data-theme="dark"] .message.user .bubble { color: #fff; }
        
        /* åˆ—è¡¨ä¼˜åŒ– */
        .bubble ul, .bubble ol { margin: 5px 0 10px 20px; padding: 0; }
        .bubble li { margin-bottom: 5px; }

        /* å¤åˆ¶æŒ‰é’® */
        .actions { display: flex; gap: 10px; margin-top: 5px; font-size: 12px; color: var(--text-sub); opacity: 0; transition: 0.3s; padding-left: 2px; }
        .actions.show { opacity: 1; }
        .act-btn { cursor: pointer; display: flex; align-items: center; gap: 3px; }
        .act-btn:active { color: var(--primary); }

        .footer { background: var(--white); border-top: 1px solid var(--border); padding: 10px 15px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); display: flex; align-items: flex-end; gap: 10px; }
        .input-box { flex: 1; min-height: 40px; max-height: 120px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; background: var(--bg); color: var(--text); resize: none; overflow-y: auto; }
        .send-btn { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-bottom: 2px; }

        /* ä¾§è¾¹æ  & é®ç½© */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; visibility: hidden; opacity: 0; transition: 0.3s; }
        .overlay.show { visibility: visible; opacity: 1; }
        .sidebar { position: absolute; top: 0; left: 0; height: 100%; width: 260px; background: var(--sidebar-bg); z-index: 60; transform: translateX(-100%); transition: 0.3s; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .sidebar.show { transform: translateX(0); }
        
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .btn-new-chat { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px; border-radius: 6px; font-size: 15px; cursor: pointer; border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-help { display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%; padding: 8px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; color: var(--text-sub); background: transparent; margin-top: 10px; }

        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .history-item.active { border-left: 3px solid var(--primary); background: rgba(7,193,96,0.1); font-weight: bold; }
        .history-actions i { padding: 5px; color: var(--text-sub); margin-left: 8px; }

        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); color: var(--text-sub); font-size: 12px; }
        .footer-row { display: flex; justify-content: space-between; margin-bottom: 15px; cursor: pointer; }
        
        /* é…ç½®é¢æ¿ */
        .config-panel { position: absolute; top: 50px; left: 0; width: 100%; background: var(--white); z-index: 55; padding: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.1); transform: translateY(-150%); transition: 0.3s; }
        .config-panel.show { transform: translateY(0); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 14px; }
        .btn-confirm { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer; }

        /* åŠ¨ç”» */
        .thinking { color: var(--text-sub); font-size: 13px; padding: 12px 18px; display: flex; align-items: center; gap: 8px; }
        .dot { width: 5px; height: 5px; background: var(--text-sub); border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        /* å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); padding: 20px; border-radius: 8px; width: 85%; max-width: 350px; color: var(--text); position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="header">
        <div class="header-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="header-title" id="header-title">æ–°ä¼šè¯</div>
        <div class="header-btn" onclick="toggleConfig()"><i class="fas fa-cog"></i></div>
    </div>

    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel" id="config-panel">
        <div class="form-group">
            <label style="color:var(--primary); font-weight:bold">ğŸ› ï¸ æ¨¡å¼é€‰æ‹©</label>
            <select id="task_mode" class="form-control" onchange="updateUI()">
                <option value="å®æˆ˜è¾…åŠ©">ğŸ’° å®æˆ˜è¾…åŠ© (AIå¸®æˆ‘å›å¤)</option>
                <option value="æ¨¡æ‹Ÿé™ªç»ƒ">ğŸ­ æ¨¡æ‹Ÿé™ªç»ƒ (AIæ‰®æ¼”å®¢æˆ·)</option>
            </select>
        </div>
        <div class="form-group">
            <label>æˆæƒç </label>
            <input type="text" id="auth_code" class="form-control" placeholder="è¯·è¾“å…¥">
        </div>
        <div class="form-group">
            <label>å·¥å·/æ‰‹æœº</label>
            <input type="text" id="phone_number" class="form-control" placeholder="è¯·è¾“å…¥">
        </div>
        <div class="form-group">
            <label>é”€å”®äº§å“</label>
            <input type="text" id="product_name" class="form-control" placeholder="æ‰‹åŠ¨è¾“å…¥äº§å“å">
        </div>
        <button class="btn-confirm" onclick="saveConfig()">ä¿å­˜è®¾ç½®</button>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="btn-new-chat" onclick="startNewChat()">+ å¼€å¯æ–°å’¨è¯¢</button>
            <button class="btn-help" onclick="showHelp()"><i class="far fa-question-circle"></i> ä½¿ç”¨è¯´æ˜</button>
        </div>
        <div class="history-list" id="history-list"></div>
        <div class="sidebar-footer">
            <div class="footer-row" onclick="toggleTheme()"><span>å¤œé—´æ¨¡å¼</span><i class="fas fa-moon"></i></div>
            <div class="clear-cache-row" onclick="clearCache()">æ¸…ç©ºç¼“å­˜</div>
            <div style="text-align:center; margin-top:10px; font-size:10px;">by å¼ å…†åå·¥ä½œå®¤</div>
        </div>
    </div>

    <div class="chat-area" id="chat-box">
        <div class="message ai">
            <div class="avatar" id="ai-avatar"></div>
            <div class="bubble-content">
                <div class="bubble">ğŸ‘‹ æ¬¢è¿ï¼è¯·ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½®ä¿¡æ¯ã€‚</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <textarea id="user_input" class="input-box" placeholder="è¾“å…¥å†…å®¹..." rows="1"></textarea>
        <div class="send-btn" id="send_btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
    </div>
</div>

<!-- è¯´æ˜å¼¹çª— -->
<div class="modal" id="help-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeHelp()">&times;</span>
        <h3>ğŸ“š ä½¿ç”¨æŒ‡å—</h3>
        <p>1. è®¾ç½®æˆæƒç å’Œäº§å“ã€‚<br>2. å®æˆ˜æ¨¡å¼ï¼šå¤åˆ¶å®¢æˆ·çš„è¯ã€‚<br>3. é™ªç»ƒæ¨¡å¼ï¼šAI æ¼”å®¢æˆ·ã€‚</p>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ æ ¸å¿ƒé…ç½®
    // ==========================================
    const WORKER_URL = 'https://ym.huaged.com'; 
    const LOG_URL = 'https://script.google.com/macros/s/AKfycbxG89jNmERWo_pCzfiqseqhfbhWE2cYUjyUE6XAz3BCb9-m_OkWZEyjDMuZAknqvg_F/exec'; 
    const AI_AVATAR_URL = 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png'; 
    // ==========================================

    let currentConvId = "";
    let chatList = JSON.parse(localStorage.getItem('med_chat_list')) || [];
    let isDark = localStorage.getItem('theme') === 'dark';

document.addEventListener('DOMContentLoaded', () => {
        loadConfig(); 
        applyTheme(); 
        renderHistory();
        
        document.querySelectorAll('.avatar').forEach(el => el.style.backgroundImage = `url('${AI_AVATAR_URL}')`);
        if (chatList.length > 0) loadChat(chatList[0].id);
        
        const input = document.getElementById('user_input');
        
        // è‡ªåŠ¨é«˜åº¦
        input.addEventListener('input', function() { 
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px'; 
        });
        
        // â˜…â˜…â˜… å¼ºåŠ›å›è½¦ä¿®å¤ (v9.0) â˜…â˜…â˜…
        input.onkeydown = function(e) {
            // è°ƒè¯•ç”¨ï¼šæŒ‰F12çœ‹æ§åˆ¶å°æœ‰æ²¡æœ‰è¿™è¡Œå­—
            // console.log("Key pressed:", e.key); 
            
            if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                e.preventDefault(); // é˜»æ­¢æ¢è¡Œ
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                
                // ç›´æ¥è°ƒç”¨ sendMessageï¼Œä¸é€šè¿‡æŒ‰é’®ç‚¹å‡»
                // è¿™æ ·æ›´ç›´æ¥ï¼Œå°‘ç»•ä¸€ä¸ªå¼¯
                if(this.value.trim() !== "") {
                    sendMessage();
                }
            }
        };
        
        updateUIByMode();
    });

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const input = document.getElementById('user_input');
        const text = input.value.trim();
        const btn = document.getElementById('send_btn');
        
        // è·å–é…ç½® (Key å·²ç»Ÿä¸€ä¸º med_)
        const auth = document.getElementById('auth_code').value.trim();
        const phone = document.getElementById('phone_number').value.trim();
        const product = document.getElementById('product_name').value.trim();
        const mode = document.getElementById('task_mode').value;

        if (!text || input.disabled) return;
        if (!auth || !phone) { alert("è¯·ç‚¹å‡»å³ä¸Šè§’âš™ï¸è®¾ç½®æˆæƒï¼"); toggleConfig(); return; }
        if (!product) { alert("è¯·è¾“å…¥äº§å“åç§°ï¼"); toggleConfig(); return; }

        appendMsg('user', text);
        input.value = ''; input.style.height = '40px'; input.blur(); closeAll();
        
        // é”å®š UI
        input.disabled = true; input.placeholder = "AI æ€è€ƒä¸­..."; btn.style.opacity = "0.5";
        const loadingId = showThinking();

        try {
            let uid = localStorage.getItem('dify_uid');
            if (!uid) { uid = "user-" + auth; localStorage.setItem('dify_uid', uid); }

            const payload = {
                "inputs": { 
                    "auth_code": auth, "phone_number": phone, 
                    "product_name": product, "task_mode": mode
                },
                "query": text,
                "response_mode": "blocking",
                "conversation_id": currentConvId,
                "user": "user-" + phone
            };

            const res = await fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // â˜…â˜…â˜… ä¿®å¤ç‚¹ï¼šå…ˆç§»é™¤åŠ¨ç”»ï¼Œé˜²æ­¢å¡æ­» â˜…â˜…â˜…
            removeThinking(loadingId);
            
            // â˜…â˜…â˜… ä¿®å¤ç‚¹ï¼šå…ˆè§£é” UIï¼Œå†å¤„ç†ç»“æœ â˜…â˜…â˜…
            input.disabled = false; updateUI(); btn.style.opacity = "1";
            if(window.innerWidth > 768) input.focus();

            if (!res.ok) throw new Error(`æœåŠ¡å¼‚å¸¸ (${res.status})`);
            
            const data = await res.json();
            
            if (data.answer) {
                appendMsg('ai', data.answer, true);
                
                // å¼‚æ­¥è®°è´¦
                logToSheet(auth, product, text, data.answer, phone, mode);

                if (currentConvId !== data.conversation_id) { 
                    currentConvId = data.conversation_id; 
                    updateChatList(currentConvId, text); 
                    renderHistory(); 
                }
                saveMsg(currentConvId, 'user', text);
                saveMsg(currentConvId, 'ai', data.answer);
            } else {
                appendMsg('ai', "âŒ " + (data.message || "æ— å›å¤"));
            }

        } catch (e) {
            removeThinking(loadingId);
            input.disabled = false; updateUI(); btn.style.opacity = "1";
            appendMsg('ai', `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`);
        }
    }

    // å­˜å–é…ç½® (Key ç»Ÿä¸€ä¸º med_)
    function saveConfig() {
        localStorage.setItem('med_auth', document.getElementById('auth_code').value);
        localStorage.setItem('med_phone', document.getElementById('phone_number').value);
        localStorage.setItem('med_product', document.getElementById('product_name').value);
        localStorage.setItem('med_mode', document.getElementById('task_mode').value);
        closeAll();
        appendMsg('system', `å·²å°±ç»ªï¼š${document.getElementById('product_name').value}`);
    }

    function loadConfig() {
        if(localStorage.getItem('med_auth')) document.getElementById('auth_code').value = localStorage.getItem('med_auth');
        if(localStorage.getItem('med_phone')) document.getElementById('phone_number').value = localStorage.getItem('med_phone');
        if(localStorage.getItem('med_product')) document.getElementById('product_name').value = localStorage.getItem('med_product');
        if(localStorage.getItem('med_mode')) document.getElementById('task_mode').value = localStorage.getItem('med_mode');
        updateUI();
    }

    // æ—¥å¿—
    function logToSheet(auth, prod, query, ans, phone, mode) {
        if(LOG_URL.includes("å¡«åœ¨è¿™é‡Œ")) return;
        let devId = localStorage.getItem('dev_id');
        if(!devId) { devId = 'dev-'+Math.random().toString(36).substr(2,8); localStorage.setItem('dev_id', devId); }
        
        fetch(LOG_URL, {
            method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
            body: JSON.stringify({
                action: "log", auth_code: auth, phone: phone, product: prod,
                mode: mode, query: query, answer: ans, device_id: devId
            })
        }).catch(e=>{});
    }

    // UI è¾…åŠ©
    function appendMsg(role, text, copy=false) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        let act = copy ? `<div class="actions show"><span class="act-btn" onclick="copyText(this, '${text.replace(/'/g, "\\'")}')"><i class="fas fa-copy"></i> å¤åˆ¶</span></div>` : '';
        const ava = role==='ai' ? `<div class="avatar" style="background-image: url('${AI_AVATAR_URL}')"></div>` : '';
        div.innerHTML = `${ava}<div class="bubble-content"><div class="bubble">${marked.parse(text)}</div>${act}</div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }
    
    function copyText(el, txt) {
        navigator.clipboard.writeText(txt);
        el.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
        setTimeout(()=>el.innerHTML='<i class="fas fa-copy"></i> å¤åˆ¶', 2000);
        let devId = localStorage.getItem('dev_id');
        fetch(LOG_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:"copy_action", device_id:devId}) }).catch(e=>{});
    }

    function showThinking() {
        const id = 'th-'+Date.now();
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.id = id; div.className = 'message ai';
        div.innerHTML = `<div class="avatar" style="background-image: url('${AI_AVATAR_URL}')"></div><div class="bubble-content"><div class="bubble thinking">æ€è€ƒä¸­...</div></div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight; return id;
    }
    function removeThinking(id) { const e=document.getElementById(id); if(e)e.remove(); }

    function toggleConfig() { 
        const p = document.getElementById('config-panel');
        const o = document.getElementById('overlay');
        if(p.classList.contains('show')) { p.classList.remove('show'); o.classList.remove('show'); }
        else { p.classList.add('show'); o.classList.add('show'); document.getElementById('sidebar').classList.remove('show'); }
    }
    function toggleSidebar() {
        const s = document.getElementById('sidebar');
        const o = document.getElementById('overlay');
        if(s.classList.contains('show')) { s.classList.remove('show'); o.classList.remove('show'); }
        else { s.classList.add('show'); o.classList.add('show'); document.getElementById('config-panel').classList.remove('show'); }
    }
    function closeAll() {
        document.getElementById('config-panel').classList.remove('show');
        document.getElementById('sidebar').classList.remove('show');
        document.getElementById('overlay').classList.remove('show');
        document.getElementById('help-modal').style.display = 'none';
    }
    function updateUI() {
        const mode = document.getElementById('task_mode').value;
        const input = document.getElementById('user_input');
        input.placeholder = mode === 'å®æˆ˜è¾…åŠ©' ? "ç²˜è´´å®¢æˆ·çš„è¯..." : "å¼€å§‹æ¨¡æ‹Ÿæ¼”ç»ƒ...";
        document.getElementById('header-title').innerText = mode;
    }
    function showHelp() { closeAll(); document.getElementById('help-modal').style.display = 'flex'; }
    function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }
    function toggleTheme() { isDark = !isDark; localStorage.setItem('theme', isDark?'dark':'light'); applyTheme(); }
    function applyTheme() { document.documentElement.setAttribute('data-theme', isDark?'dark':'light'); }
    function clearCache() { if(confirm("æ¸…é™¤ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    function startNewChat() { 
        currentConvId = ""; 
        const box = document.getElementById('chat-box');
        box.classList.add('fading');
        setTimeout(() => {
            box.innerHTML = `<div class="message ai"><div class="avatar" style="background-image: url('${AI_AVATAR_URL}')"></div><div class="bubble-content"><div class="bubble">ğŸ‘‹ æ–°ä¼šè¯å¼€å§‹ã€‚</div></div></div>`; 
            box.classList.remove('fading');
            closeAll();
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        }, 400); 
    }

    function updateChatList(id, txt) { 
        if (!chatList.find(c => c.id === id)) { 
            chatList.unshift({ id: id, title: txt.substring(0, 10)+"..." }); 
            localStorage.setItem('med_chat_list', JSON.stringify(chatList)); 
            renderHistory(); 
        } 
    }
    function renderHistory() {
        document.getElementById('history-list').innerHTML = chatList.map(c => `
            <div class="history-item ${c.id === currentConvId ? 'active' : ''}" onclick="loadChat('${c.id}')">
                <span>${c.title}</span>
                <div class="history-actions"><i class="fas fa-pen" onclick="renameChat('${c.id}', event)"></i><i class="fas fa-trash" onclick="deleteChat('${c.id}', event)"></i></div>
            </div>`).join(''); 
    }
    function renameChat(id, e) {
        e.stopPropagation();
        const chat = chatList.find(c => c.id === id);
        const newName = prompt("å¤‡æ³¨ï¼š", chat.title);
        if (newName) { chat.title = newName; localStorage.setItem('med_chat_list', JSON.stringify(chatList)); renderHistory(); }
    }
    function deleteChat(id, e) {
        e.stopPropagation();
        if(!confirm("åˆ é™¤ï¼Ÿ")) return;
        chatList = chatList.filter(c => c.id !== id);
        localStorage.setItem('med_chat_list', JSON.stringify(chatList));
        localStorage.removeItem(`med_msg_${id}`);
        renderHistory();
        if(currentConvId === id) startNewChat(); 
    }
    function loadChat(id) {
        const box = document.getElementById('chat-box');
        box.classList.add('fading');
        closeAll();
        setTimeout(() => {
            currentConvId = id; 
            const msgs = JSON.parse(localStorage.getItem(`med_msg_${id}`)) || []; 
            box.innerHTML = ''; 
            msgs.forEach(m => appendMsg(m.role, m.content));
            box.classList.remove('fading');
            renderHistory(); 
        }, 400);
    }
    function saveMsg(id, role, content) {
        let msgs = JSON.parse(localStorage.getItem(`med_msg_${id}`)) || [];
        msgs.push({ role, content });
        localStorage.setItem(`med_msg_${id}`, JSON.stringify(msgs));
    }
</script>
</body>
</html>
