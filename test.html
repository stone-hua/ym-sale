<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIåŒ»ç¾é”€å† åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 1. åŸºç¡€å˜é‡ (ä¿æŒä¸å˜) */
        :root { --primary: #07C160; --bg: #f2f2f2; --white: #ffffff; --text: #111; --text-sub: #888; --border: #e0e0e0; --user-bg: #95ec69; --ai-bg: #ffffff; --sidebar-bg: #f7f7f7; --sys-msg-bg: #e1e1e1; }
        [data-theme="dark"] { --primary: #07C160; --bg: #111111; --white: #1e1e1e; --text: #e0e0e0; --text-sub: #aaa; --border: #333; --user-bg: #056a36; --ai-bg: #2c2c2c; --sidebar-bg: #1a1a1a; --sys-msg-bg: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; background-color: #222; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; }

        /* 2. å¸ƒå±€æ¡†æ¶ */
        .app-container { width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; margin: 0 auto; z-index: 10; overflow: hidden; }
        @media (min-width: 768px) { .app-container { max-width: 450px; box-shadow: 0 0 30px rgba(0,0,0,0.5); } }

        /* 3. é¡¶éƒ¨å¯¼èˆª */
        .header { height: 50px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 20; color: var(--text); }
        .header-title { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; transition: opacity 0.3s; }
        .header-btn { font-size: 18px; cursor: pointer; padding: 8px; }

        /* 4. èŠå¤©åŒºåŸŸ */
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; gap: 15px; opacity: 1; transition: opacity 0.4s ease; }
        .chat-area.fading { opacity: 0; }
        .message { display: flex; align-items: flex-start; gap: 10px; max-width: 100%; }
        .message.user { flex-direction: row-reverse; }
        .avatar { width: 40px; height: 40px; border-radius: 6px; background-size: cover; flex-shrink: 0; border: none; }
        .message.user .avatar { display: none; }
        .bubble-content { max-width: 85%; display: flex; flex-direction: column; min-width: 0; }
        
        .bubble { padding: 12px 16px; border-radius: 8px; font-size: 15px; line-height: 1.6; position: relative; color: var(--text); word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; }
        .message.ai .bubble { background: var(--ai-bg); border: 1px solid var(--border); }
        .message.user .bubble { background: var(--user-bg); border: 1px solid transparent; color: #000; }
        [data-theme="dark"] .message.user .bubble { color: #fff; }
        .message.system { justify-content: center; margin: 10px 0; }
        .message.system .bubble { background-color: var(--sys-msg-bg); color: var(--text-sub); font-size: 13px; padding: 8px 15px; border-radius: 15px; text-align: center; border: none; }

        .bubble p { margin: 0 0 10px 0; } .bubble p:last-child { margin: 0; }
        .bubble ul, .bubble ol { margin: 5px 0 10px 20px; padding: 0; } .bubble strong { font-weight: 600; } 

        .actions { display: flex; gap: 15px; margin-top: 5px; padding-left: 2px; font-size: 12px; color: var(--text-sub); opacity: 0; transition: opacity 0.3s; }
        .actions.show { opacity: 1; }
        .message.user .actions { display: none; }
        .act-btn { cursor: pointer; display: flex; align-items: center; gap: 3px; transition: color 0.2s; }
        .act-btn:hover { color: var(--primary); }

        /* 5. åº•éƒ¨è¾“å…¥åŒº */
        .footer { background: var(--white); border-top: 1px solid var(--border); padding: 10px 15px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); display: flex; align-items: flex-end; gap: 10px; flex-shrink: 0; z-index: 20; }
        .input-box { flex: 1; min-height: 60px; max-height: 140px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; outline: none; background: var(--bg); color: var(--text); resize: none; overflow-y: auto; line-height: 1.5; font-family: inherit; touch-action: pan-y; }
        .send-btn { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-bottom: 10px; }

        /* 6. ä¾§è¾¹æ  & è®¾ç½® */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay.show { opacity: 1; visibility: visible; }
        .sidebar { position: absolute; top: 0; left: 0; height: 100%; width: 280px; max-width: 80%; background: var(--sidebar-bg); z-index: 60; transform: translateX(-100%); opacity: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .sidebar.show { transform: translateX(0); opacity: 1; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .btn-new-chat { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; font-size: 15px; cursor: pointer; background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-help { display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%; padding: 8px; border-radius: 6px; font-size: 13px; cursor: pointer; background: transparent; border: none; color: var(--text-sub); }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
        .history-item.active { background-color: rgba(7, 193, 96, 0.1); border-left: 4px solid var(--primary); color: var(--primary); font-weight: bold; }
        .history-actions i { padding: 8px; color: var(--text-sub); cursor: pointer; margin-left: 10px; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); color: var(--text-sub); font-size: 12px; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .clear-cache-row { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; cursor: pointer; text-decoration: underline; }

        /* é…ç½®é¢æ¿ */
        .config-panel { position: absolute; top: 50px; left: 0; width: 100%; background: var(--white); z-index: 55; padding: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.05); transform: translateY(-150%); opacity: 0; transition: transform 0.3s, opacity 0.3s; }
        .config-panel.show { transform: translateY(0); opacity: 1; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
        select.form-control { -webkit-appearance: none; appearance: none; background-color: var(--bg); }
        .btn-confirm { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* å¼¹çª— & åŠ¨ç”» */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); padding: 25px; border-radius: 8px; width: 85%; max-width: 400px; color: var(--text); position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        .thinking { color: var(--text-sub); font-size: 13px; padding: 12px 18px; min-width: 120px; display: flex; align-items: center; gap: 8px; }
        .dot { width: 5px; height: 5px; background: var(--text-sub); border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="header">
        <div class="header-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="header-title" id="header-title">æ–°ä¼šè¯</div>
        <div class="header-btn" onclick="toggleConfig()"><i class="fas fa-cog"></i></div>
    </div>

    <!-- é…ç½®é¢æ¿ (æç®€ç‰ˆ) -->
    <div class="config-panel" id="config-panel">
        <div class="form-group" style="border-bottom: 1px dashed var(--border); padding-bottom: 15px; margin-bottom: 15px;">
            <label style="color: var(--primary); font-weight: bold; font-size: 14px; margin-bottom: 5px;">ğŸ› ï¸ åŠŸèƒ½æ¨¡å¼</label>
            <select id="task_mode" class="form-control" style="font-weight: bold;" onchange="updateUIByMode()">
                <option value="å®æˆ˜è¾…åŠ©">ğŸ’° å®æˆ˜è¾…åŠ© (AIå¸®æˆ‘å›å¤)</option>
                <option value="æ¨¡æ‹Ÿé™ªç»ƒ">ğŸ­ æ¨¡æ‹Ÿé™ªç»ƒ (AIæ‰®æ¼”å®¢æˆ·)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>æˆæƒç </label>
            <input type="text" id="auth_code" class="form-control" placeholder="è¯·è¾“å…¥æˆæƒç ">
        </div>
        <div class="form-group">
            <label>å·¥å·/æ‰‹æœºå·</label>
            <input type="text" id="phone_number" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å·¥å·">
        </div>
        
        <div class="form-group">
            <label>é”€å”®äº§å“</label>
            <!-- çº¯æ–‡æœ¬è¾“å…¥ï¼Œæ— è”æƒ³ -->
            <input type="text" id="product_name" class="form-control" placeholder="æ‰‹åŠ¨è¾“å…¥äº§å“å (å¦‚: å°‘å¥³é’ˆ)">
        </div>

        <button class="btn-confirm" onclick="confirmConfig()">ä¿å­˜è®¾ç½®ï¼Œå¼€å§‹</button>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="btn-new-chat" onclick="startNewChat()">
                <i class="fas fa-plus"></i> å¼€å¯æ–°å’¨è¯¢
            </button>
            <button class="btn-help" onclick="showModal('help-modal')">
                <i class="far fa-question-circle"></i> ä½¿ç”¨è¯´æ˜
            </button>
        </div>
        <div class="history-list" id="history-list"></div>
        <div class="sidebar-footer">
            <div class="footer-row">
                <span>å¤œé—´æ¨¡å¼</span>
                <i class="fas fa-moon" style="cursor:pointer; font-size:18px;" onclick="toggleTheme()"></i>
            </div>
            <div class="clear-cache-row" onclick="clearCache()">æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</div>
            <div style="text-align:center; margin-top:10px; font-size:12px; color:var(--text-sub)">æŠ€æœ¯æ”¯æŒï¼šå¼ å…†åå·¥ä½œå®¤</div>
        </div>
    </div>

    <div class="chat-area" id="chat-box">
        <div class="message ai">
            <div class="avatar" id="ai-avatar"></div>
            <div class="bubble-content">
                <div class="bubble">
                    ğŸ‘‹ æ¬¢è¿ï¼æˆ‘æ˜¯æ‚¨çš„åŒ»ç¾é”€å† åŠ©æ‰‹ã€‚<br><br>
                    è¯·ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è¾“å…¥æˆæƒç ï¼Œå¹¶æ‰‹åŠ¨è¾“å…¥æ‚¨è¦å–çš„äº§å“åç§°ã€‚
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <textarea id="user_input" class="input-box" placeholder="è¾“å…¥å®¢æˆ·è¯´çš„è¯..." rows="1" maxlength="5000"></textarea>
        <div class="send-btn" id="send_btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
    </div>
</div>

<!-- ä½¿ç”¨è¯´æ˜å¼¹çª— -->
<div class="modal" id="help-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('help-modal')">&times;</span>
        <h3>ğŸ“š ä½¿ç”¨æŒ‡å—</h3>
        <br>
        <div>
            <p><strong>1. åŸºç¡€è®¾ç½®</strong><br>é¦–æ¬¡ä½¿ç”¨è¯·ç‚¹å‡»å³ä¸Šè§’é½¿è½®å›¾æ ‡ï¼Œè¾“å…¥è€æ¿ä¸‹å‘çš„æˆæƒç ï¼Œå¹¶ç»‘å®šæ‚¨çš„å·¥å·ã€‚</p>
            <p><strong>2. æ¨¡å¼åˆ‡æ¢</strong><br>ğŸ’° <strong>å®æˆ˜è¾…åŠ©</strong>ï¼šå¤åˆ¶å®¢æˆ·è¯´çš„è¯å‘ç»™AIï¼ŒAIä¼šæ ¹æ®äº§å“èµ„æ–™ç»™æ‚¨é«˜æƒ…å•†å›å¤è¯æœ¯ã€‚<br>ğŸ­ <strong>æ¨¡æ‹Ÿé™ªç»ƒ</strong>ï¼šAIä¼šæ‰®æ¼”åˆé’»å®¢æˆ·ï¼Œæ‚¨æ¥å›å¤ï¼ŒAIä¼šç»™æ‚¨çš„å›å¤æ‰“åˆ†ã€‚</p>
            <p><strong>3. äº§å“è¾“å…¥</strong><br>è¯·åœ¨è®¾ç½®é¡µæ‰‹åŠ¨è¾“å…¥äº§å“åç§°ï¼ˆéœ€ä¸è€æ¿åå°è¡¨æ ¼ä¸€è‡´ï¼‰ï¼ŒAIä¼šè‡ªåŠ¨è¯»å–åå°æ•°æ®ã€‚</p>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ æ ¸å¿ƒé…ç½®åŒº
    // ==========================================
    const WORKER_URL = 'https://ym.huaged.com'; // Cloudflare åœ°å€
    const LOG_URL = 'https://script.google.com/macros/s/AKfycbxG89jNmERWo_pCzfiqseqhfbhWE2cYUjyUE6XAz3BCb9-m_OkWZEyjDMuZAknqvg_F/exec'; // Google è„šæœ¬ URL (v15.0)
    const AI_AVATAR_URL = 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png'; 
    // ==========================================

    let currentConvId = "";
    let chatList = JSON.parse(localStorage.getItem('med_chat_list')) || [];
    let isDark = localStorage.getItem('theme') === 'dark';

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        loadConfig(); 
        applyTheme(); 
        renderHistory();
        
        document.querySelectorAll('.avatar').forEach(el => el.style.backgroundImage = `url('${AI_AVATAR_URL}')`);
        if (chatList.length > 0) loadChat(chatList[0].id);
        
        const input = document.getElementById('user_input');
        input.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) { e.preventDefault(); sendMessage(); } });
        
        updateUIByMode();
    });

    // UI äº¤äº’
    function toggleSidebar() { closeConfig(); document.getElementById('sidebar').classList.toggle('show'); document.getElementById('overlay').classList.toggle('show'); }
    function toggleConfig() { closeSidebar(); document.getElementById('config-panel').classList.toggle('show'); document.getElementById('overlay').classList.toggle('show'); }
    function closeAll() { 
        document.getElementById('sidebar').classList.remove('show'); 
        document.getElementById('config-panel').classList.remove('show'); 
        document.getElementById('overlay').classList.remove('show'); 
        document.getElementById('help-modal').style.display = 'none';
    }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('show'); }
    function closeConfig() { document.getElementById('config-panel').classList.remove('show'); }
    function showModal(id) { closeAll(); document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function updateUIByMode() {
        const mode = document.getElementById('task_mode').value;
        const input = document.getElementById('user_input');
        if (mode === 'æ¨¡æ‹Ÿé™ªç»ƒ') {
            input.placeholder = "å¼€å§‹ä½ çš„é”€å”®æ¼”ç»ƒ...";
            document.getElementById('header-title').innerText = "æ¨¡æ‹Ÿé™ªç»ƒ";
        } else {
            input.placeholder = "å¤åˆ¶å®¢æˆ·çš„è¯ç²˜è´´åœ¨è¿™é‡Œ...";
            document.getElementById('header-title').innerText = "å®æˆ˜è¾…åŠ©";
        }
    }

    function confirmConfig() {
        const auth = document.getElementById('auth_code').value.trim();
        const phone = document.getElementById('phone_number').value.trim();
        const product = document.getElementById('product_name').value.trim();

        if (!auth || !phone) { alert("è¯·å®Œå–„æˆæƒç å’Œå·¥å·ï¼"); return; }
        if (!product) { alert("è¯·è¾“å…¥é”€å”®äº§å“åç§°ï¼"); return; }

        saveConfig();
        closeAll();
        updateUIByMode();
        
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = 'message system';
        div.innerHTML = `<div class="bubble-content"><div class="bubble">âœ… é…ç½®å·²æ›´æ–°<br>äº§å“ï¼š<b>${product}</b></div></div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const input = document.getElementById('user_input');
        const sendBtn = document.getElementById('send_btn');
        const text = input.value.trim();
        
        if (input.disabled || !text) return;

        const auth = document.getElementById('auth_code').value.trim();
        const phone = document.getElementById('phone_number').value.trim();
        const product = document.getElementById('product_name').value.trim();
        const mode = document.getElementById('task_mode').value;

        if (!auth || !phone) { alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’âš™ï¸è®¾ç½®ï¼"); toggleConfig(); return; }
        if (!product) { alert("è¯·è¾“å…¥äº§å“åç§°ï¼"); toggleConfig(); return; }

        appendMessage('user', text);
        input.value = ''; input.style.height = '60px'; input.blur(); closeAll();
        input.disabled = true; input.placeholder = "AI æ­£åœ¨æ€è€ƒ...";
        sendBtn.style.pointerEvents = "none"; sendBtn.style.opacity = "0.5";
        
        const loadingId = showThinking();

        try {
            let userId = localStorage.getItem('dify_uid');
            if (!userId) { userId = "user-" + auth; localStorage.setItem('dify_uid', userId); }

            const payload = {
                "inputs": { 
                    "auth_code": auth,
                    "phone_number": phone,
                    "product_name": product,
                    "task_mode": mode
                },
                "query": text,
                "response_mode": "blocking",
                "conversation_id": currentConvId,
                "user": userId
            };

            const fetchWithRetry = async (url, options, n = 3) => {
                try { return await fetch(url, options); } 
                catch (err) { if (n <= 1) throw err; await new Promise(r => setTimeout(r, 1000)); return await fetchWithRetry(url, options, n - 1); }
            };

            const response = await fetchWithRetry(WORKER_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload) 
            });

            removeThinking(loadingId);
            const data = await res.json(); // æ³¨æ„ï¼šè¿™é‡Œé€šå¸¸éœ€è¦ .json()ï¼Œä¹‹å‰ v3 ä»£ç é‡Œå¯èƒ½æ¼äº† error handling
            // å¦‚æœ Cloudflare Worker è¿”å›çš„æ˜¯çº¯æ–‡æœ¬ï¼Œè¯·æ”¹ç”¨ await response.text()
            
            if (data.answer) {
                appendMessage('ai', data.answer, true);
                
                // æ—¥å¿—ä¸ŠæŠ¥ (åŒ…å«å·¥å·)
                let devId = localStorage.getItem('dev_id');
                if(!devId) { devId = 'dev-'+Math.random().toString(36).substr(2,9); localStorage.setItem('dev_id', devId); }
                
                fetch(LOG_URL, {
                    method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify({
                        action: "log",
                        auth_code: auth, phone: phone, product: product,
                        query: text, answer: data.answer, device_id: devId
                    })
                }).catch(e=>{});
            } else {
                appendMessage('ai', "âŒ " + (data.message || "è¯·æ±‚å¤±è´¥"));
            }

            if (currentConvId !== data.conversation_id) { 
                currentConvId = data.conversation_id; 
                updateChatList(currentConvId, text); 
                renderHistory(); 
            }
            saveMsg(currentConvId, 'user', text);
            if (data.answer) saveMsg(currentConvId, 'ai', data.answer);

        } catch (error) {
            removeThinking(loadingId);
            appendMessage('ai', `âŒ ç½‘ç»œé”™è¯¯ï¼š${error.message}`);
        } finally {
            input.disabled = false; updateUIByMode(); sendBtn.style.pointerEvents = "auto"; sendBtn.style.opacity = "1";
        }
    }

    // è¾…åŠ©å‡½æ•°
    function appendMessage(role, text, showCopy=false) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        let actions = '';
        if (showCopy) {
            actions = `
                <div class="actions show">
                    <span class="act-btn" onclick="copyText(this, '${text.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')"><i class="fas fa-copy"></i> å¤åˆ¶è¯æœ¯</span>
                </div>`;
        }

        const avatar = role === 'ai' ? `<div class="avatar" style="background-image: url('${AI_AVATAR_URL}')"></div>` : '';
        div.innerHTML = `${avatar}<div class="bubble-content"><div class="bubble">${marked.parse(text)}</div>${actions}</div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    function copyText(el, txt) {
        navigator.clipboard.writeText(txt);
        const original = el.innerHTML;
        el.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
        setTimeout(()=>el.innerHTML=original, 2000);
        // ä¸ŠæŠ¥
        let devId = localStorage.getItem('dev_id');
        fetch(LOG_URL, {
            method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'},
            body:JSON.stringify({action:"copy_action", device_id:devId})
        }).catch(e=>{});
    }

    function showThinking() {
        const id = 'th-'+Date.now();
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.id = id; div.className = 'message ai';
        div.innerHTML = `<div class="avatar" style="background-image: url('${AI_AVATAR_URL}')"></div><div class="bubble-content"><div class="bubble thinking">æ€è€ƒä¸­ <div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight; 
        return id;
    }
    function removeThinking(id) { const e=document.getElementById(id); if(e)e.remove(); }

    function startNewChat() { 
        currentConvId = ""; 
        document.getElementById('chat-box').innerHTML = `<div class="message ai"><div class="avatar" style="background-image: url('${AI_AVATAR_URL}')"></div><div class="bubble-content"><div class="bubble">ğŸ‘‹ æ–°ä¼šè¯å¼€å§‹ã€‚</div></div></div>`; 
        closeAll(); renderHistory(); 
    }
    function updateChatList(id, firstMsg) { 
        if (!chatList.find(c => c.id === id)) { 
            chatList.unshift({ id: id, title: firstMsg.substring(0, 10)+"..." }); 
            localStorage.setItem('med_chat_list', JSON.stringify(chatList)); 
            renderHistory(); 
        } 
    }
    function renderHistory() {
        document.getElementById('history-list').innerHTML = chatList.map(c => `
            <div class="history-item ${c.id === currentConvId ? 'active' : ''}" onclick="loadChat('${c.id}')">
                <span>${c.title}</span>
                <div class="history-actions"><i class="fas fa-trash" onclick="deleteChat('${c.id}', event)"></i></div>
            </div>`).join(''); 
    }
    function loadChat(id) {
        currentConvId = id; closeAll();
        const msgs = JSON.parse(localStorage.getItem(`med_msg_${id}`)) || []; 
        document.getElementById('chat-box').innerHTML = ''; 
        msgs.forEach(m => appendMessage(m.role, m.content));
    }
    function deleteChat(id, e) {
        e.stopPropagation();
        if(!confirm("åˆ é™¤ï¼Ÿ")) return;
        chatList = chatList.filter(c => c.id !== id);
        localStorage.setItem('med_chat_list', JSON.stringify(chatList));
        localStorage.removeItem(`med_msg_${id}`);
        renderHistory();
        if(currentConvId === id) startNewChat();
    }
    function saveMsg(id, role, content) {
        let msgs = JSON.parse(localStorage.getItem(`med_msg_${id}`)) || [];
        msgs.push({ role, content });
        localStorage.setItem(`med_msg_${id}`, JSON.stringify(msgs));
    }
    function saveConfig() {
        localStorage.setItem('med_auth', document.getElementById('auth_code').value);
        localStorage.setItem('med_phone', document.getElementById('phone_number').value);
        localStorage.setItem('med_mode', document.getElementById('task_mode').value);
        localStorage.setItem('med_product', document.getElementById('product_name').value);
    }
    function loadConfig() {
        if(localStorage.getItem('med_auth')) document.getElementById('auth_code').value = localStorage.getItem('med_auth');
        if(localStorage.getItem('med_phone')) document.getElementById('phone_number').value = localStorage.getItem('med_phone');
        if(localStorage.getItem('med_mode')) document.getElementById('task_mode').value = localStorage.getItem('med_mode');
        if(localStorage.getItem('med_product')) document.getElementById('product_name').value = localStorage.getItem('med_product');
        updatePlaceholder();
    }
    function clearCache() { if(confirm("æ¸…é™¤ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function toggleTheme() { 
        isDark = !isDark; localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
        applyTheme();
    }
    function applyTheme() { document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light'); }

</script>
</body>
</html>
